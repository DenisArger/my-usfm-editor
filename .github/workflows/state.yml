name: Move Issue to IN_PROGRESS on Branch Creation

on:
    create:

jobs:
  update_issue_status:
    runs-on: ubuntu-latest
    steps:
      - name: Get Issue ID from Project
        id: get_issue_id
        run: |
          RESPONSE=$(curl -X POST https://api.github.com/graphql \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"query\":\"query { node(id: \\\"${{ secrets.ID_PROJECT_SKILLDOR }}\\\") { ... on ProjectV2 { items(first: 100) { nodes { id content { ... on Issue { number title } } } } } } }\"}")

          echo "🔍 Full API Response: $RESPONSE"  # Debugging

          # Извлекаем ID Issue
          ISSUE_ID=$(echo "$RESPONSE" | jq -r ".data.node.items.nodes[] | select(.content.number == ${ISSUE_NUMBER}) | .id")

          if [ -z "$ISSUE_ID" ] || [ "$ISSUE_ID" == "null" ]; then
            echo "🚨 Ошибка: Issue с номером ${ISSUE_NUMBER} не найден!"
            exit 1
          fi

          echo "✅ Найден ISSUE_ID: $ISSUE_ID"
          echo "ISSUE_ID=$ISSUE_ID" >> $GITHUB_ENV

      - name: Move Issue to IN_PROGRESS
        run: |
          curl -X POST https://api.github.com/graphql \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"query\":\"mutation { updateProjectV2ItemFieldValue(input: { projectId: \\\"${{ secrets.ID_PROJECT_SKILLDOR }}\\\", itemId: \\\"$ISSUE_ID\\\", fieldId: \\\"${{ secrets.ID_COLUMN_STATUS_NEED_DEFINITION_SKILLDOR }}\\\", value: {singleSelectOptionId:\\\"${{ secrets.ID_COLUMN_STATUS_IN_PROGRESS_SKILLDOR }}\\\"} }) { clientMutationId } }\"}"
