name: Update Issue Status to DONE on PR Merge into develop

on:
  pull_request:
    types: [closed]

jobs:
  update-status:
    runs-on: ubuntu-latest
    # –®–∞–≥–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ PR —Å–º–µ—Ä–∂–µ–Ω –∏ –±–∞–∑–æ–≤–∞—è –≤–µ—Ç–∫–∞ ‚Äî develop
    if: ${{ github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'develop' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up environment variables
        run: |
          echo "TOKEN_AUTOMATIZATION=${{ secrets.TOKEN_AUTOMATIZATION }}" >> $GITHUB_ENV
          echo "ID_PROJECT_SKILLDOR=${{ secrets.ID_PROJECT_SKILLDOR }}" >> $GITHUB_ENV
          echo "ID_COLUMN_STATUS_SKILLDOR=${{ secrets.ID_COLUMN_STATUS_SKILLDOR }}" >> $GITHUB_ENV
          echo "ID_COLUMN_STATUS_DONE_SKILLDOR=${{ secrets.ID_COLUMN_STATUS_DONE_SKILLDOR }}" >> $GITHUB_ENV
          echo "ID_COLUMN_STATUS_BLOCKED_SKILLDOR=${{ secrets.ID_COLUMN_STATUS_BLOCKED_SKILLDOR }}" >> $GITHUB_ENV
          echo "ID_COLUMN_STATUS_TO_DO_SKILLDOR=${{ secrets.ID_COLUMN_STATUS_TO_DO_SKILLDOR }}" >> $GITHUB_ENV

      - name: Update task status to DONE
        run: |
          set -euo pipefail

          LOG_FILE="pr_done.log"
          log() {
            echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
          }
          error_exit() {
            log "üö® –û—à–∏–±–∫–∞: $1"
            exit 1
          }

          log "==================== –ó–∞–ø—É—Å–∫ workflow –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ DONE ===================="

          CURRENT_BRANCH="${{ github.event.pull_request.head.ref }}"
          log "PR –≤–µ—Ç–∫–∞: $CURRENT_BRANCH"

          # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –∑–∞–¥–∞—á–∏ –∏–∑ –∏–º–µ–Ω–∏ –≤–µ—Ç–∫–∏ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –Ω–æ–º–µ—Ä –∑–∞–¥–∞—á–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ç—Ä–µ—Ç—å–µ–º –±–ª–æ–∫–µ —á–µ—Ä–µ–∑ '-')
          ISSUE_NUMBER=$(echo "$CURRENT_BRANCH" | cut -d'-' -f3)
          if [ -z "$ISSUE_NUMBER" ]; then
            error_exit "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –Ω–æ–º–µ—Ä –∑–∞–¥–∞—á–∏ –∏–∑ –∏–º–µ–Ω–∏ –≤–µ—Ç–∫–∏!"
          fi
          log "–ò–∑–≤–ª–µ—á—ë–Ω ISSUE_NUMBER: $ISSUE_NUMBER"

          # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞ —á–µ—Ä–µ–∑ GraphQL-–∑–∞–ø—Ä–æ—Å
          GRAPHQL_QUERY='{"query": "query { node(id: \"'"$ID_PROJECT_SKILLDOR"'\") { ... on ProjectV2 { items(first: 100) { nodes { id content { ... on Issue { number title } } } } } } }"}'
          log "üì° –û—Ç–ø—Ä–∞–≤–ª—è–µ–º GraphQL-–∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞..."
          RESPONSE=$(curl -s -X POST https://api.github.com/graphql \
            -H "Authorization: Bearer $TOKEN_AUTOMATIZATION" \
            -H "Content-Type: application/json" \
            -d "$GRAPHQL_QUERY") || error_exit "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ GraphQL-–∑–∞–ø—Ä–æ—Å–∞"
          if echo "$RESPONSE" | jq -e '.errors' >/dev/null; then
            error_exit "–ü–æ–ª—É—á–µ–Ω—ã –æ—à–∏–±–∫–∏ –æ—Ç GitHub API: $(echo "$RESPONSE" | jq '.errors')"
          fi
          log "‚úÖ –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã"

          # –ü–æ–∏—Å–∫ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ –Ω–æ–º–µ—Ä—É –∑–∞–¥–∞—á–∏
          ISSUE_ITEM_ID=$(echo "$RESPONSE" | jq -r ".data.node.items.nodes[] | select(.content.number == $ISSUE_NUMBER) | .id")
          if [ -z "$ISSUE_ITEM_ID" ] || [ "$ISSUE_ITEM_ID" == "null" ]; then
            error_exit "Issue —Å –Ω–æ–º–µ—Ä–æ–º $ISSUE_NUMBER –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ç–µ!"
          fi
          log "‚úÖ –ù–∞–π–¥–µ–Ω ISSUE_ITEM_ID: $ISSUE_ITEM_ID"

          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º GraphQL-–º—É—Ç–∞—Ü–∏—é –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏ –Ω–∞ DONE
          GRAPHQL_MUTATION='{"query": "mutation { updateProjectV2ItemFieldValue(input: { projectId: \"'"$ID_PROJECT_SKILLDOR"'\", itemId: \"'"$ISSUE_ITEM_ID"'\", fieldId: \"'"$ID_COLUMN_STATUS_SKILLDOR"'\", value: { singleSelectOptionId: \"'"$ID_COLUMN_STATUS_DONE_SKILLDOR"'\" } }) { clientMutationId } }"}'
          log "üì° –û—Ç–ø—Ä–∞–≤–ª—è–µ–º GraphQL-–º—É—Ç–∞—Ü–∏—é –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏ –Ω–∞ DONE..."
          MUTATION_RESPONSE=$(curl -s -X POST https://api.github.com/graphql \
            -H "Authorization: Bearer $TOKEN_AUTOMATIZATION" \
            -H "Content-Type: application/json" \
            -d "$GRAPHQL_MUTATION") || error_exit "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ GraphQL-–º—É—Ç–∞—Ü–∏–∏"
          log "üîÑ –û—Ç–≤–µ—Ç GitHub API:"
          echo "$MUTATION_RESPONSE" | jq . | tee -a "$LOG_FILE"
          if echo "$MUTATION_RESPONSE" | jq -e '.errors' >/dev/null; then
            error_exit "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏: $(echo "$MUTATION_RESPONSE" | jq '.errors')"
          fi

          log "üéâ –°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ $ISSUE_NUMBER —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω –Ω–∞ DONE"

      - name: Process blocked tasks and update to TODO if unblocked
        run: |
          set -euo pipefail

          log() {
            echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a pr_done.log
          }
          error_exit() {
            log "üö® –û—à–∏–±–∫–∞: $1"
            exit 1
          }

          log "==================== –ê–Ω–∞–ª–∏–∑ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á ===================="

          # –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π GraphQL-–∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–¥–∞—á –ø—Ä–æ–µ–∫—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ Issue –∏ —Å—Ç–∞—Ç—É—Å–æ–º (–ø–æ–ª–µ "Status")
          GRAPHQL_QUERY_BLOCKED='{"query": "query { node(id: \"'"$ID_PROJECT_SKILLDOR"'\") { ... on ProjectV2 { items(first: 100) { nodes { id content { ... on Issue { number title body } } fieldValueByName(name: \"Status\") { ... on ProjectV2SingleSelectFieldValue { optionId name } } } } } } }"}'
          log "üì° –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö"
          RESPONSE_ALL=$(curl -s -X POST https://api.github.com/graphql \
            -H "Authorization: Bearer $TOKEN_AUTOMATIZATION" \
            -H "Content-Type: application/json" \
            -d "$GRAPHQL_QUERY_BLOCKED") || error_exit "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ GraphQL-–∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –≤—Å–µ—Ö –∑–∞–¥–∞—á"
          if echo "$RESPONSE_ALL" | jq -e '.errors' >/dev/null; then
            error_exit "–ü–æ–ª—É—á–µ–Ω—ã –æ—à–∏–±–∫–∏ –æ—Ç GitHub API: $(echo "$RESPONSE_ALL" | jq '.errors')"
          fi
          log "‚úÖ –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á"

          # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–¥–∞—á, –Ω–∞—Ö–æ–¥—è—â–∏—Ö—Å—è –≤ –∫–æ–ª–æ–Ω–∫–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
          BLOCKED_ITEMS=$(echo "$RESPONSE_ALL" | jq -r '.data.node.items.nodes[] | select(.fieldValueByName.optionId == "'$ID_COLUMN_STATUS_BLOCKED_SKILLDOR'") | @base64')
          for item in $BLOCKED_ITEMS; do
            _jq() {
              echo ${item} | base64 --decode | jq -r ${1}
            }
            BLOCKED_ITEM_ID=$(_jq '.id')
            ISSUE_NUMBER_BLOCKED=$(_jq '.content.number')
            ISSUE_BODY=$(_jq '.content.body')
            log "üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–∞–¥–∞—á—É #$ISSUE_NUMBER_BLOCKED —Å ID $BLOCKED_ITEM_ID"

            # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –±–ª–æ–∫–∏—Ä—É—é—â–µ–π –∑–∞–¥–∞—á–∏ –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è (—Ñ–æ—Ä–º–∞—Ç: "BLOCKED BY #<–Ω–æ–º–µ—Ä>")
            BLOCKING_NUMBER=$(echo "$ISSUE_BODY" | grep -o -E 'BLOCKED BY #[0-9]+' | head -n 1 | grep -o -E '[0-9]+')
            if [ -z "$BLOCKING_NUMBER" ]; then
              log "‚ùó –ó–∞–¥–∞—á–∞ #$ISSUE_NUMBER_BLOCKED –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–ª–æ–∫–∏—Ä—É—é—â–µ–π –∑–∞–¥–∞—á–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
              continue
            fi
            log "‚õì –ù–∞–π–¥–µ–Ω–∞ –±–ª–æ–∫–∏—Ä—É—é—â–∞—è –∑–∞–¥–∞—á–∞: #$BLOCKING_NUMBER"

            # –ü–æ–∏—Å–∫ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –±–ª–æ–∫–∏—Ä—É—é—â–µ–π –∑–∞–¥–∞—á–µ
            BLOCKING_ITEM=$(echo "$RESPONSE_ALL" | jq -r ".data.node.items.nodes[] | select(.content.number == $BLOCKING_NUMBER)")
            if [ -z "$BLOCKING_ITEM" ]; then
              log "‚ùó –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –±–ª–æ–∫–∏—Ä—É—é—â–∞—è –∑–∞–¥–∞—á–∞ #$BLOCKING_NUMBER –≤ –ø—Ä–æ–µ–∫—Ç–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
              continue
            fi

            BLOCKING_STATUS=$(echo "$BLOCKING_ITEM" | jq -r '.fieldValueByName.optionId')
            if [ "$BLOCKING_STATUS" != "$ID_COLUMN_STATUS_DONE_SKILLDOR" ]; then
              log "üîí –ë–ª–æ–∫–∏—Ä—É—é—â–∞—è –∑–∞–¥–∞—á–∞ #$BLOCKING_NUMBER –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ (—Å—Ç–∞—Ç—É—Å: $BLOCKING_STATUS), –∑–∞–¥–∞—á–∞ #$ISSUE_NUMBER_BLOCKED –æ—Å—Ç–∞–µ—Ç—Å—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π"
              continue
            fi

            log "‚úÖ –ë–ª–æ–∫–∏—Ä—É—é—â–∞—è –∑–∞–¥–∞—á–∞ #$BLOCKING_NUMBER –≤—ã–ø–æ–ª–Ω–µ–Ω–∞, –ø–µ—Ä–µ–Ω–æ—Å–∏–º –∑–∞–¥–∞—á—É #$ISSUE_NUMBER_BLOCKED –≤ TODO"

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º GraphQL-–º—É—Ç–∞—Ü–∏—é –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏ –Ω–∞ TODO
            GRAPHQL_MUTATION_TODO='{"query": "mutation { updateProjectV2ItemFieldValue(input: { projectId: \"'"$ID_PROJECT_SKILLDOR"'\", itemId: \"'"$BLOCKED_ITEM_ID"'\", fieldId: \"'"$ID_COLUMN_STATUS_SKILLDOR"'\", value: { singleSelectOptionId: \"'"$ID_COLUMN_STATUS_TO_DO_SKILLDOR"'\" } }) { clientMutationId } }"}'
            MUTATION_TODO_RESPONSE=$(curl -s -X POST https://api.github.com/graphql \
              -H "Authorization: Bearer $TOKEN_AUTOMATIZATION" \
              -H "Content-Type: application/json" \
              -d "$GRAPHQL_MUTATION_TODO") || error_exit "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ GraphQL-–º—É—Ç–∞—Ü–∏–∏ –¥–ª—è –∑–∞–¥–∞—á–∏ #$ISSUE_NUMBER_BLOCKED"
            echo "$MUTATION_TODO_RESPONSE" | jq . | tee -a pr_done.log
            if echo "$MUTATION_TODO_RESPONSE" | jq -e '.errors' >/dev/null; then
              error_exit "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ #$ISSUE_NUMBER_BLOCKED: $(echo "$MUTATION_TODO_RESPONSE" | jq '.errors')"
            fi
            log "üéâ –ó–∞–¥–∞—á–∞ #$ISSUE_NUMBER_BLOCKED —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–∞ –≤ TODO"
          done

      - name: Upload log file
        uses: actions/upload-artifact@v4
        with:
          name: pr-done-log
          path: pr_done.log
